{% extends "base.html" %}
{% load static %}

{% block modal %}
    <div class="modal fade" id="modal-update" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
            </div>
        </div>
    </div>
{% endblock %}

{% block sidebar %}
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="sidebar-sticky pt-3">
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>indexes</span>
                <button id="new_index" type="button" class="btn btn-outline-success">+</button>
            </h6>
            {% if list_indices %}
                <ul class="nav flex-column" id="index-list">
                    {% for index, name, color in list_indices %}
                        <li class="nav-item">
                            <label class="check_container" data-index="{{index}}" data-color="{{color}}">{{name}} 
                                <input type="checkbox">
                                <span class="checkmark"></span>
                            </label>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="alert alert-primary" role="alert">
                    No indexes found!
                </div>
            {% endif %}
            <hr />
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>plugins</span>
            </h6>
            <div id="plugin_info">
            <ul class="nav flex-column" id="list_plugin">
            </ul>
        </div>
    </nav>  
{% endblock sidebar %}          

{% block content%}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Info selected</h1>
    </div>
    <div id="main_stage" class="table-responsive">
        <table id="example" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>INFO!</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Please select indexes and plugin!</td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock content %}


{% block javascript %}
    {{block.super}}
    <script src="{% static "file_form/file_form.js" %}"></script>
    <script type="text/javascript">
        $(document).ready(function() {

            var table = $('#example').DataTable();
            $('#example').empty();
            table.clear().draw();
            
            // ADD OR REMOVE INDEX REFRESH DATA AND AVAILABLE PLUGINS
            $(document).on('change', ".check_container :checkbox", function() {
                $('#example').empty();
                table.clear().draw();
                if(this.checked) {
                    var a = $("input:checked ~ .checkmark", $(this).closest(".check_container"));
                    a.css("background-color", $(this).closest(".check_container").data("color"));
                }else{
                    var a = $("input ~ .checkmark", $(this).closest(".check_container"));
                    a.css("background-color", "#ccc");
                }
                update_plugins();
            });

            // FUNCTION TO REFRESH PLUGIN LIST
            function update_plugins(){
                var indexes = [];
                $("#list_plugin").html('');
                $(".check_container :checked").each(function(){
                    indexes.push($(this).closest('.check_container').data('index'));
                });
                $.get("{% url 'plugins' %}", {'indexes': indexes})
                    .done(function(data){
                        if(data.length > 0){
                            $.each(data, function(i, plugin){
                                var item = '<li class="nav-item"><label class="radio_container" data-plugin="' + plugin + '">' + plugin + '<input type="radio" name="radio"><span class="checkmark"></span></label></li>';
                                $("#list_plugin").append(item);
                            })
                        }
                    })
            }

            // GET DATA
            $(document).on('change', 'input[type=radio][name=radio]', function() {
                plugin = $(this).parents('li').find('label').data('plugin');
                var indexes = [];
                $(".check_container :checked").each(function(){
                    indexes.push($(this).closest('.check_container').data('index'));
                });
                $.get("{% url 'analysis' %}", {'indexes': indexes, 'plugin': plugin})
                    .done(function(data){
                        
                        var columns = [{
                            "className": 'details-control',
                            "orderable": false,
                            "data": null,
                            "defaultContent": ''
                        }];
                        columnNames = Object.keys(data.data[0]);
                        for(var i in columnNames) {
                            if(i != 0)
                                columns.push({data: columnNames[i], title: columnNames[i]});
                        }
    
                        table.destroy();
                        $('#example').empty();

                        table = $("#example").DataTable({
                            "data": data.data,
                            "columns": columns,
                            "rowCallback" : function(row, data){
                                column = this.api().column(-1).index('visible');
                                $('td', row).eq(column).html('<svg class="bd-placeholder-img rounded mr-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" focusable="false" role="img"><rect width="100%" height="100%" fill="' + data.color + '"></rect></svg>');
                            }
                        });
                    });
            });

            // SHOW CHILDRENS
            $(document).on('click', '#example tbody td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row( tr );
        
                if ( row.child.isShown() ) {
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    row.child( format(row.data()) ).show();
                    tr.addClass('shown');
                }
            } );

            // FORMAT CHILDRENS
            function format ( d ) {
                // `d` is the original data object for the row
                var str = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
                if(d.__children.length > 0){
                    var childNames = Object.keys(d.__children[0]);
                    str = str + '<tr>';
                    for(var k in childNames){
                        str = str + '<th>' + childNames[k] + '</th>';
                    }
                    str = str + '</tr>';
                    for(var child in d.__children){
                        str = str + '<tr>';
                        for(var k in childNames){
                            str = str + '<td>' + d.__children[child][childNames[k]] + '</td>';
                        }                        
                        str = str + '</td>'
                    }
                    str = str + '</table>';
                    return str;
                }else{
                    return null;
                }
            }

            // ADD INDEX FORM
            $(document).on("click", "#new_index", function(){
                $.ajax({
                url: "{% url 'index_create'%}",
                type: 'get',
                dataType: 'json',
                beforeSend: function () {
                    $("#modal-update").modal("show");
                },
                success: function (data) {
                    $("#modal-update .modal-content").html(data.html_form);
                    initUploadFields(document.getElementById("create-index"));
                    jscolor.installByClassName('jscolor');
                }
                });
            });

            // ADD INDEX FORM SUBMIT
            $(document).on("submit", "#create-index", function(e){
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr("action"),
                    data: form.serialize(),
                    type: form.attr("method"),
                    dataType: 'json',
                    success: function (data) {
                        if (data.form_is_valid) {
                            $("#index-list").html('');
                            data.new_indices.forEach(index => $("#index-list").append('<li class="nav-item"><label class="check_container" data-index="' + index[0] + '" data-color="' + index[1] + '">' + index[2] + '<input type="checkbox"><span class="checkmark"></span></label>'));
                            $("#modal-update").modal('hide');
                        }else {
                            $("#modal-update .modal-content").html(data.html_form);
                        }
                    }
                });
            });
        } );
    </script>
{% endblock javascript %}